{% block head %} {% include 'layouts/head.html' %} {% endblock %}
<script>
    $(function() {
        $('#tabla').DataTable({
            "language": {
                "emptyTable": "No hay datos disponibles en la tabla",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                "infoFiltered": "(filtrado de _MAX_ entradas totales)",
                "lengthMenu": "Mostrar _MENU_ entradas",
                "loadingRecords": "Cargando...",
                "processing": "Procesando...",
                "search": "Buscar:",
                "zeroRecords": "No se encontraron registros coincidentes",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            },
            "order": [
                [0, "desc"]
            ],
        });
    });
</script>

<body class="body-inicio">
    {% block navbar %} {% include 'layouts/navbar.html' %} {% endblock %}
    <section class="align-items-center justify-content-center">
        <div class="container" data-aos="fade-up">
            <div class="row" style="margin-bottom: 2rem;">
                <div class="card" style="border-block-color: rgba(50, 81, 220, 0.6);writing-mode: horizontal-tb;overflow: auto;">
                    <div class="card-body">
                        <h2>Datos de Irradiancia - Davis</h2>
                        {% if db_irr is not none %}
                        <table id="tabla" class="table table-responsive ">
                            <thead>
                                <tr>
                                    <th style="width: 12rem;">Fecha y Hora</th>
                                    <th>Irradiancia Promedio (W/m²)</th>
                                    <th>Irradiancia Máxima (W/m²)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for db_irr in db_irr %}
                                <tr>
                                    <td>{{db_irr[2]}}</td>
                                    <td class="avg_irradiance">{{db_irr[0]}}</td>
                                    <td class="highest_irradiance">{{db_irr[1]}}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p class="text-danger ">Error: No se encontraron datos de irradiancia.</p>
                        {% endif %}

                    </div>
                </div>
            </div>
            <div class="row" style="margin-bottom: 2rem;">
                <div class="d-flex align-items-center" style="margin-bottom: 1rem;">
                    <input type="date" class="form-control" style="width:16rem; margin-right: 1rem;" id="dateSelector" />
                    <button id="filterButton" class="btn btn-primary">Filtrar</button>
                </div>
                <canvas id="myChart" width="350" height="100"></canvas>
                <script>
                    const irradianceData = [];
                    const highestIrradianceData = [];
                    const labels = [];

                    const tableRows = document.querySelectorAll('#tabla tbody tr');

                    tableRows.forEach(row => {
                        const avgIrradianceCell = row.querySelector('.avg_irradiance');
                        const highestIrradianceCell = row.querySelector('.highest_irradiance');
                        const irradianceValue = avgIrradianceCell ? parseFloat(avgIrradianceCell.textContent) : null;
                        const highestIrradianceValue = highestIrradianceCell ? parseFloat(highestIrradianceCell.textContent) : null;
                        const dateString = row.querySelector('td:first-child').textContent;
                        const date = new Date(dateString);
                        const label = date.toLocaleTimeString([], {
                            hour: '2-digit',
                            minute: '2-digit'
                        }); // Formatear solo la hora y los minutos


                        if (irradianceValue !== null) {
                            irradianceData.push(irradianceValue);
                            labels.push(label);
                        }

                        if (highestIrradianceValue !== null) {
                            highestIrradianceData.push(highestIrradianceValue);
                        }
                    });

                    const ctx = document.getElementById('myChart').getContext('2d');


                    let chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                type: 'line',
                                label: 'Irradiancia Promedio (W/m²)',
                                data: irradianceData,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                pointHitRadius: 5,
                                borderWidth: 2,
                                tension: 0.2,
                            }, {
                                type: 'line',
                                label: 'Irradiancia Máxima (W/m²)',
                                data: highestIrradianceData,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                pointHitRadius: 5,
                                borderWidth: 2,
                                tension: 0.2,
                            }]
                        },
                        options: {
                            animation: {
                                x: {
                                    type: 'number',
                                    easing: 'linear',
                                    duration: 2000,
                                    from: NaN,
                                    delay(ctx) {
                                        const delayBetweenPoints = 1000 / Math.max(irradianceData.length, highestIrradianceData.length);
                                        if (ctx.datasetIndex === 0) {
                                            return ctx.index * delayBetweenPoints;
                                        } else {
                                            return 0;
                                        }
                                    }
                                }
                            },
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            }
                        }
                    });

                    document.getElementById('filterButton').addEventListener('click', () => {
                        const selectedDate = document.getElementById('dateSelector').value;
                        if (selectedDate) {
                            const filteredLabels = [];
                            const filteredIrradianceData = [];
                            const filteredHighestIrradianceData = [];

                            tableRows.forEach(row => {
                                const label = row.querySelector('td:first-child').textContent;
                                const date = new Date(label);
                                const dateString = date.toISOString().split('T')[0]; // Convertir a formato YYYY-MM-DD

                                if (dateString === selectedDate) {
                                    const avgIrradianceCell = row.querySelector('.avg_irradiance');
                                    const highestIrradianceCell = row.querySelector('.highest_irradiance');
                                    const irradianceValue = avgIrradianceCell ? parseFloat(avgIrradianceCell.textContent) : null;
                                    const highestIrradianceValue = highestIrradianceCell ? parseFloat(highestIrradianceCell.textContent) : null;
                                    const label = date.toLocaleTimeString([], {
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    }); // Formatear solo la hora y los minutos

                                    if (irradianceValue !== null) {
                                        filteredIrradianceData.push(irradianceValue);
                                        filteredLabels.push(label);
                                    }

                                    if (highestIrradianceValue !== null) {
                                        filteredHighestIrradianceData.push(highestIrradianceValue);
                                    }
                                }
                            });

                            chart.data.labels = filteredLabels;
                            chart.data.datasets[0].data = filteredIrradianceData;
                            chart.data.datasets[1].data = filteredHighestIrradianceData;
                            chart.update();
                        }
                    });
                </script>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts "></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js "></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/datatables.js"></script>
    <script src="/static/js/scripts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</body>